!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@wonderlandlabs/validators"),require("@wonderlandlabs/propper"),require("crypto")):"function"==typeof define&&define.amd?define(["@wonderlandlabs/validators","@wonderlandlabs/propper","crypto"],e):(t=t||self).LGE=e(t.validators,t.propper,t.crypto)}(this,(function(t,e,r){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */
var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function o(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function s(t){return"function"==typeof t}var i=!1,u={Promise:void 0,set useDeprecatedSynchronousErrorHandling(t){t&&(new Error).stack;i=t},get useDeprecatedSynchronousErrorHandling(){return i}};function c(t){setTimeout((function(){throw t}),0)}var a={closed:!0,next:function(t){},error:function(t){if(u.useDeprecatedSynchronousErrorHandling)throw t;c(t)},complete:function(){}},h=function(){return Array.isArray||function(t){return t&&"number"==typeof t.length}}();function p(t){return null!==t&&"object"==typeof t}var l=function(){function t(t){return Error.call(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(t,e){return e+1+") "+t.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t,this}return t.prototype=Object.create(Error.prototype),t}(),f=function(){function t(t){this.closed=!1,this._parentOrParents=null,this._subscriptions=null,t&&(this._ctorUnsubscribe=!0,this._unsubscribe=t)}return t.prototype.unsubscribe=function(){var e;if(!this.closed){var r=this._parentOrParents,n=this._ctorUnsubscribe,o=this._unsubscribe,i=this._subscriptions;if(this.closed=!0,this._parentOrParents=null,this._subscriptions=null,r instanceof t)r.remove(this);else if(null!==r)for(var u=0;u<r.length;++u){r[u].remove(this)}if(s(o)){n&&(this._unsubscribe=void 0);try{o.call(this)}catch(t){e=t instanceof l?d(t.errors):[t]}}if(h(i)){u=-1;for(var c=i.length;++u<c;){var a=i[u];if(p(a))try{a.unsubscribe()}catch(t){e=e||[],t instanceof l?e=e.concat(d(t.errors)):e.push(t)}}}if(e)throw new l(e)}},t.prototype.add=function(e){var r=e;if(!e)return t.EMPTY;switch(typeof e){case"function":r=new t(e);case"object":if(r===this||r.closed||"function"!=typeof r.unsubscribe)return r;if(this.closed)return r.unsubscribe(),r;if(!(r instanceof t)){var n=r;(r=new t)._subscriptions=[n]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}var o=r._parentOrParents;if(null===o)r._parentOrParents=this;else if(o instanceof t){if(o===this)return r;r._parentOrParents=[o,this]}else{if(-1!==o.indexOf(this))return r;o.push(this)}var s=this._subscriptions;return null===s?this._subscriptions=[r]:s.push(r),r},t.prototype.remove=function(t){var e=this._subscriptions;if(e){var r=e.indexOf(t);-1!==r&&e.splice(r,1)}},t.EMPTY=function(t){return t.closed=!0,t}(new t),t}();function d(t){return t.reduce((function(t,e){return t.concat(e instanceof l?e.errors:e)}),[])}var b=function(){return"function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random()}(),y=function(t){function e(r,n,o){var s=t.call(this)||this;switch(s.syncErrorValue=null,s.syncErrorThrown=!1,s.syncErrorThrowable=!1,s.isStopped=!1,arguments.length){case 0:s.destination=a;break;case 1:if(!r){s.destination=a;break}if("object"==typeof r){r instanceof e?(s.syncErrorThrowable=r.syncErrorThrowable,s.destination=r,r.add(s)):(s.syncErrorThrowable=!0,s.destination=new v(s,r));break}default:s.syncErrorThrowable=!0,s.destination=new v(s,r,n,o)}return s}return o(e,t),e.prototype[b]=function(){return this},e.create=function(t,r,n){var o=new e(t,r,n);return o.syncErrorThrowable=!1,o},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){this.destination.error(t),this.unsubscribe()},e.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},e.prototype._unsubscribeAndRecycle=function(){var t=this._parentOrParents;return this._parentOrParents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parentOrParents=t,this},e}(f),v=function(t){function e(e,r,n,o){var i,u=t.call(this)||this;u._parentSubscriber=e;var c=u;return s(r)?i=r:r&&(i=r.next,n=r.error,o=r.complete,r!==a&&(s((c=Object.create(r)).unsubscribe)&&u.add(c.unsubscribe.bind(c)),c.unsubscribe=u.unsubscribe.bind(u))),u._context=c,u._next=i,u._error=n,u._complete=o,u}return o(e,t),e.prototype.next=function(t){if(!this.isStopped&&this._next){var e=this._parentSubscriber;u.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?this.__tryOrSetError(e,this._next,t)&&this.unsubscribe():this.__tryOrUnsub(this._next,t)}},e.prototype.error=function(t){if(!this.isStopped){var e=this._parentSubscriber,r=u.useDeprecatedSynchronousErrorHandling;if(this._error)r&&e.syncErrorThrowable?(this.__tryOrSetError(e,this._error,t),this.unsubscribe()):(this.__tryOrUnsub(this._error,t),this.unsubscribe());else if(e.syncErrorThrowable)r?(e.syncErrorValue=t,e.syncErrorThrown=!0):c(t),this.unsubscribe();else{if(this.unsubscribe(),r)throw t;c(t)}}},e.prototype.complete=function(){var t=this;if(!this.isStopped){var e=this._parentSubscriber;if(this._complete){var r=function(){return t._complete.call(t._context)};u.useDeprecatedSynchronousErrorHandling&&e.syncErrorThrowable?(this.__tryOrSetError(e,r),this.unsubscribe()):(this.__tryOrUnsub(r),this.unsubscribe())}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(t,e){try{t.call(this._context,e)}catch(t){if(this.unsubscribe(),u.useDeprecatedSynchronousErrorHandling)throw t;c(t)}},e.prototype.__tryOrSetError=function(t,e,r){if(!u.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,r)}catch(e){return u.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0,!0):(c(e),!0)}return!1},e.prototype._unsubscribe=function(){var t=this._parentSubscriber;this._context=null,this._parentSubscriber=null,t.unsubscribe()},e}(y);var w=function(){return"function"==typeof Symbol&&Symbol.observable||"@@observable"}();function _(t){return t}function m(t){return 0===t.length?_:1===t.length?t[0]:function(e){return t.reduce((function(t,e){return e(t)}),e)}}var S=function(){function t(t){this._isScalar=!1,t&&(this._subscribe=t)}return t.prototype.lift=function(e){var r=new t;return r.source=this,r.operator=e,r},t.prototype.subscribe=function(t,e,r){var n=this.operator,o=function(t,e,r){if(t){if(t instanceof y)return t;if(t[b])return t[b]()}return t||e||r?new y(t,e,r):new y(a)}(t,e,r);if(n?o.add(n.call(o,this.source)):o.add(this.source||u.useDeprecatedSynchronousErrorHandling&&!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),u.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},t.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){u.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(t){for(;t;){var e=t,r=e.closed,n=e.destination,o=e.isStopped;if(r||o)return!1;t=n&&n instanceof y?n:null}return!0}(t)?console.warn(e):t.error(e)}},t.prototype.forEach=function(t,e){var r=this;return new(e=g(e))((function(e,n){var o;o=r.subscribe((function(e){try{t(e)}catch(t){n(t),o&&o.unsubscribe()}}),n,e)}))},t.prototype._subscribe=function(t){var e=this.source;return e&&e.subscribe(t)},t.prototype[w]=function(){return this},t.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return 0===t.length?this:m(t)(this)},t.prototype.toPromise=function(t){var e=this;return new(t=g(t))((function(t,r){var n;e.subscribe((function(t){return n=t}),(function(t){return r(t)}),(function(){return t(n)}))}))},t.create=function(e){return new t(e)},t}();function g(t){if(t||(t=Promise),!t)throw new Error("no Promise impl found");return t}var x=function(){function t(){return Error.call(this),this.message="object unsubscribed",this.name="ObjectUnsubscribedError",this}return t.prototype=Object.create(Error.prototype),t}(),E=function(t){function e(e,r){var n=t.call(this)||this;return n.subject=e,n.subscriber=r,n.closed=!1,n}return o(e,t),e.prototype.unsubscribe=function(){if(!this.closed){this.closed=!0;var t=this.subject,e=t.observers;if(this.subject=null,e&&0!==e.length&&!t.isStopped&&!t.closed){var r=e.indexOf(this.subscriber);-1!==r&&e.splice(r,1)}}},e}(f),j=function(t){function e(e){var r=t.call(this,e)||this;return r.destination=e,r}return o(e,t),e}(y),P=function(t){function e(){var e=t.call(this)||this;return e.observers=[],e.closed=!1,e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return o(e,t),e.prototype[b]=function(){return new j(this)},e.prototype.lift=function(t){var e=new O(this,this);return e.operator=t,e},e.prototype.next=function(t){if(this.closed)throw new x;if(!this.isStopped)for(var e=this.observers,r=e.length,n=e.slice(),o=0;o<r;o++)n[o].next(t)},e.prototype.error=function(t){if(this.closed)throw new x;this.hasError=!0,this.thrownError=t,this.isStopped=!0;for(var e=this.observers,r=e.length,n=e.slice(),o=0;o<r;o++)n[o].error(t);this.observers.length=0},e.prototype.complete=function(){if(this.closed)throw new x;this.isStopped=!0;for(var t=this.observers,e=t.length,r=t.slice(),n=0;n<e;n++)r[n].complete();this.observers.length=0},e.prototype.unsubscribe=function(){this.isStopped=!0,this.closed=!0,this.observers=null},e.prototype._trySubscribe=function(e){if(this.closed)throw new x;return t.prototype._trySubscribe.call(this,e)},e.prototype._subscribe=function(t){if(this.closed)throw new x;return this.hasError?(t.error(this.thrownError),f.EMPTY):this.isStopped?(t.complete(),f.EMPTY):(this.observers.push(t),new E(this,t))},e.prototype.asObservable=function(){var t=new S;return t.source=this,t},e.create=function(t,e){return new O(t,e)},e}(S),O=function(t){function e(e,r){var n=t.call(this)||this;return n.destination=e,n.source=r,n}return o(e,t),e.prototype.next=function(t){var e=this.destination;e&&e.next&&e.next(t)},e.prototype.error=function(t){var e=this.destination;e&&e.error&&this.destination.error(t)},e.prototype.complete=function(){var t=this.destination;t&&t.complete&&this.destination.complete()},e.prototype._subscribe=function(t){return this.source?this.source.subscribe(t):f.EMPTY},e}(P),k=function(t){function e(e){var r=t.call(this)||this;return r._value=e,r}return o(e,t),Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!0,configurable:!0}),e.prototype._subscribe=function(e){var r=t.prototype._subscribe.call(this,e);return r&&!r.closed&&e.next(this._value),r},e.prototype.getValue=function(){if(this.hasError)throw this.thrownError;if(this.closed)throw new x;return this._value},e.prototype.next=function(e){t.prototype.next.call(this,this._value=e)},e}(P);function T(t){return t&&"function"==typeof t.schedule}var A=function(t){return function(e){for(var r=0,n=t.length;r<n&&!e.closed;r++)e.next(t[r]);e.complete()}};function V(t,e){return e?function(t,e){return new S((function(r){var n=new f,o=0;return n.add(e.schedule((function(){o!==t.length?(r.next(t[o++]),r.closed||n.add(this.schedule())):r.complete()}))),n}))}(t,e):new S(A(t))}function D(t,e){return function(r){if("function"!=typeof t)throw new TypeError("argument is not a function. Are you looking for `mapTo()`?");return r.lift(new C(t,e))}}var C=function(){function t(t,e){this.project=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new H(t,this.project,this.thisArg))},t}(),H=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.project=r,o.count=0,o.thisArg=n||o,o}return o(e,t),e.prototype._next=function(t){var e;try{e=this.project.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(y),M=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.prototype.notifyNext=function(t,e,r,n,o){this.destination.next(e)},e.prototype.notifyError=function(t,e){this.destination.error(t)},e.prototype.notifyComplete=function(t){this.destination.complete()},e}(y),U=function(t){function e(e,r,n){var o=t.call(this)||this;return o.parent=e,o.outerValue=r,o.outerIndex=n,o.index=0,o}return o(e,t),e.prototype._next=function(t){this.parent.notifyNext(this.outerValue,t,this.outerIndex,this.index++,this)},e.prototype._error=function(t){this.parent.notifyError(t,this),this.unsubscribe()},e.prototype._complete=function(){this.parent.notifyComplete(this),this.unsubscribe()},e}(y);function z(){return"function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator"}var R=z();var Y=function(t){if(t&&"function"==typeof t[w])return o=t,function(t){var e=o[w]();if("function"!=typeof e.subscribe)throw new TypeError("Provided object does not correctly implement Symbol.observable");return e.subscribe(t)};if((n=t)&&"number"==typeof n.length&&"function"!=typeof n)return A(t);if(function(t){return!!t&&"function"!=typeof t.subscribe&&"function"==typeof t.then}(t))return r=t,function(t){return r.then((function(e){t.closed||(t.next(e),t.complete())}),(function(e){return t.error(e)})).then(null,c),t};if(t&&"function"==typeof t[R])return e=t,function(t){for(var r=e[R]();;){var n=void 0;try{n=r.next()}catch(e){return t.error(e),t}if(n.done){t.complete();break}if(t.next(n.value),t.closed)break}return"function"==typeof r.return&&t.add((function(){r.return&&r.return()})),t};var e,r,n,o,s=p(t)?"an invalid object":"'"+t+"'";throw new TypeError("You provided "+s+" where a stream was expected. You can provide an Observable, Promise, Array, or Iterable.")};function B(t,e,r,n,o){if(void 0===o&&(o=new U(t,r,n)),!o.closed)return e instanceof S?e.subscribe(o):Y(e)(o)}var N={};var q=function(){function t(t){this.resultSelector=t}return t.prototype.call=function(t,e){return e.subscribe(new I(t,this.resultSelector))},t}(),I=function(t){function e(e,r){var n=t.call(this,e)||this;return n.resultSelector=r,n.active=0,n.values=[],n.observables=[],n}return o(e,t),e.prototype._next=function(t){this.values.push(N),this.observables.push(t)},e.prototype._complete=function(){var t=this.observables,e=t.length;if(0===e)this.destination.complete();else{this.active=e,this.toRespond=e;for(var r=0;r<e;r++){var n=t[r];this.add(B(this,n,void 0,r))}}},e.prototype.notifyComplete=function(t){0==(this.active-=1)&&this.destination.complete()},e.prototype.notifyNext=function(t,e,r){var n=this.values,o=n[r],s=this.toRespond?o===N?--this.toRespond:this.toRespond:0;n[r]=e,0===s&&(this.resultSelector?this._tryResultSelector(n):this.destination.next(n.slice()))},e.prototype._tryResultSelector=function(t){var e;try{e=this.resultSelector.apply(this,t)}catch(t){return void this.destination.error(t)}this.destination.next(e)},e}(M);function K(t,e){return function(r){return r.lift(new L(t,e))}}var L=function(){function t(t,e){this.predicate=t,this.thisArg=e}return t.prototype.call=function(t,e){return e.subscribe(new $(t,this.predicate,this.thisArg))},t}(),$=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.predicate=r,o.thisArg=n,o.count=0,o}return o(e,t),e.prototype._next=function(t){var e;try{e=this.predicate.call(this.thisArg,t,this.count++)}catch(t){return void this.destination.error(t)}e&&this.destination.next(t)},e}(y);const F=Symbol("ABSENT"),G=t=>t===F,J=t=>t,Q=(new k(null),t()),W=Q.is("function"),X=Q.is("array"),Z=Q.is("object"),tt=Q.is("string");Q.is("number"),Q.is("map"),Q.is("set");function et(t,e){return function(r){return r.lift(new rt(t,e))}}var rt=function(){function t(t,e){this.compare=t,this.keySelector=e}return t.prototype.call=function(t,e){return e.subscribe(new nt(t,this.compare,this.keySelector))},t}(),nt=function(t){function e(e,r,n){var o=t.call(this,e)||this;return o.keySelector=n,o.hasKey=!1,"function"==typeof r&&(o.compare=r),o}return o(e,t),e.prototype.compare=function(t,e){return t===e},e.prototype._next=function(t){var e;try{var r=this.keySelector;e=r?r(t):t}catch(t){return this.destination.error(t)}var n=!1;if(this.hasKey)try{n=(0,this.compare)(this.key,e)}catch(t){return this.destination.error(t)}else this.hasKey=!0;n||(this.key=e,this.destination.next(t))},e}(y);let ot={},st=(t=21)=>{let e=(t=>{let e=ot[t];return e||(e=Buffer.allocUnsafe(t),t<=255&&(ot[t]=e)),r.randomFillSync(e)})(t),n="";for(;t--;)n+="ModuleSymbhasOwnPr-0123456789ABCDEFGHNRVfgctiUvz_KqYTJkLxpZXIjQW"[63&e[t]];return n};const it=(...t)=>{let e=t;do{e=e.reduce((t,e)=>X(e)?[...t,...e]:[...t,e],[])}while(e.some(X));return e};var ut=t=>{do{t=it(t)}while(t.some(X));return t};class ct{constructor(t,e,r=F){this.value=e,this.nextValue=e,this.lastValue=G(r)?t.value:r,this.stream=t,this.id="change_"+st()}get redundant(){return!this.stream._compare(this.stream.value,this.nextValue)}get name(){return this.stream.name}toJSON(t){const e={id:t||this.id,value:this.value,lastValue:this.lastValue};return G(this.nextValue)||(e.nextValue=this.nextValue),G(this.lastValue)||(e.lastValue=this.lastValue),this.thrown&&(e.thrown=this.thrown.message?this.thrown.message:this.thrown,e.thrownAt=this.thrownAt),this.stream.errors.length&&(e.errors=[...this.stream.errors]),(this.stream.notes&&!X(this.stream.notes)||X(this.stream.notes)&&this.stream.notes.length)&&(e.notes=this.stream.notes),e}get thrownString(){return this.thrown.reduce((t,e)=>[...t,e.message],[]).join(",")}}e.proppify(ct).addProp("stream").addProp("value").addProp("thrown").addProp("thrownAt","","string").addProp("nextValue",F).addProp("lastValue").addProp("notes");class at{constructor(t=F){this._id=(()=>{const t=`${Math.random()} ${Date.now()}`.replace(/[\D]/g,"");let e="";return t.split("").forEach(t=>{Math.random()>.5?e+=t:e=t+e,e.length%4||(e+="-")}),e})(),G(t)||this.subject.next(t)}get id(){return this._id}complete(){this.subSets.forEach(t=>t.complete()),this.subSets.clear(),this.done=!0}}e.proppify(at).addProp("subject",()=>new k(null)).addProp("subSets",()=>new Set).addProp("done",!1,"boolean");class ht extends at{constructor(t,e,r=null,n=J){super(r),this.name=e,this.store=t,this.pre=n,this.next(r),this._initialized=!0}get value(){return this.subject.value}subscribe(...t){const e=this.subject.subscribe(...t);return this.subSets.add(e),e}complete(){this.subject.complete(),this.changes.complete(),super.complete()}next(t){if(this.done)return;this._reset();const e=new ct(this,t);try{e.nextValue=this.pre(t,this)}catch(t){e.thrown=t,t.change=e,e.thrownAt="pre"}if(e.thrown||this.subject.next(e.nextValue),Object.assign(e,function(t,e){return Z(t)?ut(e).reduce((e,r)=>(e[r]=t[r],e),{}):{}}(this,"errors")),this.store.next(e),e.thrown)throw e.thrown}_reset(){this.errors=[],this.notes=null}}e.proppify(ht).addProp("errors",()=>[],"array").addProp("notes",null).addProp("pre",J,"function").addProp("changes",()=>new P);const pt=t=>tt(t)?t.charAt(0).toLowerCase()+t.slice(1):"",lt=/^set(.+)$/i;class ft extends at{constructor(t={},e={}){super(),this._blockCountStream=new k(0),this.addStreams(t),this.addActions(e)}addActions(t){if(!Z(t))throw new Error("non-obj set to addActions");Object.keys(t).forEach(e=>{this.actions.set(e,(...r)=>t[e](this,...r))})}block(t){}get subjectChoked(){return this.__subjectChoked||(this.__subjectChoked=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=void 0,n=void 0;return T(t[t.length-1])&&(n=t.pop()),"function"==typeof t[t.length-1]&&(r=t.pop()),1===t.length&&h(t[0])&&(t=t[0]),V(t,n).lift(new q(r))}(this._pendingCountSubject,super.subject).pipe(K(([t])=>!t),D(([t,e])=>e),et())),this.__subjectChoked}addStreams(t){if(!Z(t))throw new Error("non-obj set to addStreams");return Object.keys(t).forEach(e=>{const r=t[e];Array.isArray(r)&&W(r[1])?this._makeStream(e,...r):this._makeStream(e,r)}),this.next(),this}_makeStream(t,e,r=J){this.streams.set(t,new ht(this,t,e,r)),delete this._do}property(...t){return this.stream(...t)}stream(t,e,r){return this._makeStream(t,e,r),this.next(),this}subscribe(...t){const e=this.subjectChoked.subscribe(...t);return this.subSets.add(e),e}complete(){this.subject.complete(),this.streams.forEach(t=>t.complete()),super.complete()}next(t){if(t){if(this._pending.add(t),t instanceof ct&&t.thrown)return;this._update(t)}this.broadcast()}updateStream(t,e){if(this.streams.has(t))try{this.streams.get(t).next(e)}catch(t){return t}else{if(lt.test(t)){const r=t.match(lt)[1];return this.updateStream(pt(r),e)}{const r=pt(t);if(this.stream.has(r))return this.updateStream(t,r,e)}}return!1}_getDo(){const t={};return this.streams.keys().forEach(e=>{var r;t["set"+(r=e,tt(r)?r.charAt(0).toUpperCase()+r.slice(1):"")]=t=>this.updateStream(e,t)}),t}virtual(t,e,...r){const n=ut(r),o=new k(F);o.name=t;try{o.next(e(this.values(n)))}catch(e){console.log("failed to initialize virtual ",t,"from ",n),this._initialized&&this.next(Object.assign(new ct(o,F),{thrown:e,thrownAt:"virtual-initialization"}))}this.streams.set(t,o);let s=null;this.subSets.add(o.subscribe(t=>{if(G(t))return;const e=new ct(o,t,s);s=t,this.next(e)})),this.changes.pipe(K(t=>t instanceof ct&&!t.thrown&&n.include(t.name))).subscribe(()=>{try{const t=e(this.values(n));o.next(t)}catch(t){this.next(Object.assign(new ct(o,F,s),{thrown:t,thrownAt:"virtual"}))}})}_doProxy(){return new Proxy(this,{get:(t,e)=>r=>t.updateStream(e,r)})}get do(){return this._do||("undefined"==typeof Proxy?this._do||(this._do=this._getDo()):this._do=this._doProxy()),this._do}broadcast(){const t=this.values();this.subject.next(t)}_update(t){this._push(t),this.changes.next(t),this._pop(t)}_pop(t){this._pending.delete(t),this._pendingCountSubject.next(this._pending.size)}_push(t){this._pending.add(t),this._pendingCountSubject.next(this._pending.size)}get value(){return this.subject.value}values(t=null){const e={};return this.streams.forEach((r,n)=>{X(t)&&!t.includes(n)||W(t)&&!t(r,n)||(e[n]=r.value)}),e}}e.proppify(ft).addProp("actions",()=>new Map).addProp("changes",new P).addProp("_pending",()=>new Set).addProp("_pendingCountSubject",()=>new k(0).pipe(D(t=>0===t?0:1),et())).addProp("streams",()=>new Map);class dt{constructor(t){this.subjectBlock=t}complete(){this.subjectBlock.blockDone(this)}}class bt{block(){const t=new dt(this);return this.blocks.add(t),this.update(),t}blockDone(t){this.blocks.delete(t),this.update()}do(t){const e=this.block(),r=[];try{r[1]=t(e)}catch(t){r[0]=t}return e.complete(),r}update(){this.subject.next(this.blocks.size)}}return e.proppify(bt).addProp("subject",()=>new k(0).pipe(et())).addProp("blocks",()=>new Set),{validators:Q,Stream:ht,ValueStore:ft,ABSENT:F,SubjectBlock:bt,Change:ct}}));
